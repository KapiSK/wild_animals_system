# 外部サーバー 要件定義書

## 1. 概要

本システムは、エッジデバイス（Raspberry Pi + ESP32カメラ群）から送信される画像データを受信し、AIモデル（MegaDetector v5）を用いて動物の検出・分類・カウントを行い、検出時に管理者にメールで通知する外部サーバーシステムである。

## 2. システム構成

- **サーバー種別**: クラウドサーバー または オンプレミスサーバー (Linux/Ubuntu環境推奨)
- **エッジ連携**: Raspberry Pi（エッジサーバー）からのHTTP POSTリクエストを受信
- **推論エンジン**: PyTorch / Ultralytics (MegaDetector v5a)
- **通知手段**: SMTPメールサーバー (Gmail等)

## 3. 機能要件

### 3.1 データ受信機能

- **APIエンドポイント**: `POST /upload`
- **受信データ**:
  - 画像ファイル (JPEG推奨)
  - メタデータ (必要に応じて拡張)
- **レスポンス**: 受信成功時にHTTP 200 OKとJSONメッセージを即座に返却（非同期処理への引き渡し）。

### 3.2 推論・解析機能

- **使用モデル**: MegaDetector v5a (`md_v5a.0.0.pt`)
- **自動ダウンロード**: モデルファイルがローカルに存在しない場合、システム起動時に自動的に指定URLからダウンロードする。
- **検出対象**:
  - MegaDetectorのクラス `0` (Animal) のみを検出対象とする。
  - 人 (`1`) や乗り物 (`2`) は検出対象外とする（または設定により無視する）。
- **画像処理**:
  - 検出された動物に対してバウンディングボックス (BB) を描画する。
  - 検出された動物の数をカウントする。
  - 処理済み画像を別ディレクトリ (`processed_images/`) に保存する。

### 3.3 通知機能

- **メール通知**:
  - 動物が1匹以上検出された場合にのみ通知を行う。
  - **件名**: 検出された動物の種類と数を含む（例: "Wild Animal Detected: animal: 2"）。
  - **本文**: 検出時刻、検出詳細を記載。
  - **添付ファイル**: バウンディングボックス描画済みの画像を添付する。
- **SMTP設定**: 環境変数によりSMTPサーバー、ポート、認証情報、宛先を設定可能とする。

## 4. 非機能要件

### 4.1 性能要件

- **非同期処理**: 画像受信と推論処理を分離し、画像受信APIのレスポンス遅延を防ぐ（FastAPI `BackgroundTasks` の利用）。
- **スループット**: 連続した画像アップロードに対しても、順次キューイングして処理を行う。

### 4.2 信頼性・可用性

- **自動復旧**: サーバープロセスが停止した場合、Systemd等の仕組みにより自動再起動する。
- **ログ機能**: 処理の開始、検出結果、エラー発生時などをログファイルまたは標準出力に記録する。

### 4.3 セキュリティ

- **環境変数**: メールパスワードやAPIキー等の機密情報はソースコードに直書きせず、`.env` ファイルから読み込む。
- **通信**: 公開サーバーとして運用する場合、リバースプロキシ (Nginx等) でSSL/TLS化することが望ましい（本サーバー単体ではHTTP動作）。

## 5. 運用環境

- **OS**: Linux (Ubuntu 20.04/22.04 LTS 推奨)
- **言語**: Python 3.8以上
- **依存ライブラリ**: `requirements.txt` に定義 (FastAPI, Uvicorn, Ultralytics, OpenCV, aiosmtplib, requests等)
