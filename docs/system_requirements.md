# システム全体要件定義書

## 1. システム概要

本システムは、野生動物の行動を監視・記録するためのIoTシステムである。
森林などの屋外環境に設置された複数の**エッジデバイス（トレイルカメラ）**が動物を検知・撮影し、**エッジサーバー**での一次フィルタリングを経由して、**外部サーバー**へデータを送信する。
外部サーバーでは高度なAIモデルを用いて画像の詳細解析を行い、検出結果を管理者に通知する。

## 2. システム構成

システムは主に以下の3つのコンポーネントで構成される。

1. **エッジデバイス (Sensing Device)**
    * ハードウェア: ESP32-S3 (XIAO ESP32S3) + Camera + GPS + PIR Sensor
    * 役割: 動体検知、3枚1サイクルの画像撮影、位置情報付与、エッジサーバーへのデータ送信。
2. **エッジサーバー (Gateway/Edge Server)**
    * ハードウェア: Raspberry Pi
    * 役割: 複数カメラからのデータ集約、SDカードへの保存、**YOLOv8n**による一次フィルタリング、外部サーバーへの転送。
3. **外部サーバー (Cloud/Analysis Server)**
    * ハードウェア: PC / Cloud Instance (Linux)
    * 役割: 高度なAI推論（**MegaDetector v5**）、検出画像の加工（BB描画）、ユーザー通知 (Gmail SMTP)。

## 3. 機能要件

### 3.1 エッジデバイス (ESP32 Camera)

* **撮影機能**:
  * PIRセンサー検知時、**1サイクルにつき3枚**の画像を連続撮影する。
* **メタデータとファイル名**:
  * サイクルごとに一意のID (Cycle ID) を生成する。
  * ファイル名形式: `{CycleID}-{1~3}.jpg` (例: `A1B2C3D4-1.jpg`)
  * **時刻**: GPSまたはNTPによる正確なタイムスタンプ。
  * **位置情報**: GPSモジュール (GT-502MGG-N) から取得した緯度経度。
  * **昼夜判定**: 明るさまたは時刻に基づき、ファイル名に識別子 (`n`/`d`) を付与する（例: `{CycleID}-{1~3}n.jpg`）。
* **データ送信**:
  * Wi-Fi (または ESP-WIFI-MESH) を介してエッジサーバーへ画像をアップロードする。
* **オフラインバッファリング**: 通信断時はSDカードに画像を保存し、接続回復時に再送する。

### 3.2 エッジサーバー (Raspberry Pi)

* **データ受信・保存**:
  * エッジデバイスから受信した画像は、全てローカルの**SDカードに保存**する。
* **一次フィルタリング (YOLOv8n)**:
  * 受信した画像に対し、Raspberry Pi上で**YOLOv8n** (General Object Detection) を実行し、動物（class: bird, cat, dog, horse, sheep, cow, elephant, bear, zebra, giraffe等）の有無を判定する。
  * **転送判定**: 1サイクル（3枚）のうち、**2枚以上**で動物が検出された場合のみ、そのサイクルの画像3枚全てを外部サーバーへ転送候補とする。
* **データ転送**:
  * フィルタリングを通過した画像を外部サーバーへ送信する。

### 3.3 外部サーバー (Analysis Server)

* **データ受信**: エッジサーバーからの画像アップロードを受け付ける。
* **高度AI推論 (MegaDetector)**:
  * 送られてきた画像に対し、**MegaDetector v5a** を使用して動物の検出・カウントを行う。
* **画像加工**:
  * 検出された動物に対し**バウンディングボックス (BB)** を描画する。
  * BB描画済み画像は、元画像とは別のファイルとして保存する。
* **通知機能**:
  * **Gmail SMTP** を使用して通知を行う。
  * 通知内容: 検出日時、検出された動物の種類・数、**BB描画済みの画像**。

## 4. 非機能要件

* **耐環境性**: エッジデバイスは屋外設置に耐える防水・防塵設計であること。
* **省電力性**: エッジデバイスはDeep Sleepを活用し、長期間のバッテリー駆動を実現する。
* **処理性能**: エッジサーバー（RasPi）でのYOLOv8n推論を効率的に行う（軽量モデルの利用）。
* **セキュリティ**:
  * SMTP認証情報やAPIキーは `.env` 等で安全に管理する。
